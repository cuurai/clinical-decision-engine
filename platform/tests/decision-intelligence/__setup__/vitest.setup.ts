/**
 * Vitest global setup
 *
 * Generated by Test Generator v1.0.0
 * Generator Version: 1.0.0
 * Domain: decision-intelligence
 *
 * âš ï¸  DO NOT EDIT THIS FILE MANUALLY
 * This file is auto-generated. Any manual changes will be overwritten.
 */


/**
 * Vitest Global Setup
 *
 * Configures test environment with:
 * - Testcontainers Postgres
 * - Frozen time
 * - Seeded faker
 * - Baseline data
 */

import { beforeAll, afterAll, beforeEach, afterEach, vi } from "vitest";
import { startTestDb, stopTestDb, getPrismaClient } from "./test-db.setup.js";
import { seedBaselineData } from "./seed.js";

// Set required environment variables
process.env.TZ = "UTC";
process.env.TEST_FIXED_DATE = "2025-01-01T00:00:00Z";
process.env.TEST_FAKER_SEED = "12345";

/**
 * Global setup - runs once per worker
 */
beforeAll(async () => {
  console.log("ğŸš€ Starting test environment...");

  // Start Testcontainers (initializes prisma)
  const client = await startTestDb();

  // Make prisma available globally (AFTER initialization)
  (globalThis as any).prisma = client;

  // Seed baseline data (orgs, users)
  await seedBaselineData();

  console.log("âœ… Test environment ready");
}, 60000); // 60s timeout for container startup

/**
 * Global teardown - runs once per worker
 */
afterAll(async () => {
  await stopTestDb();
});

/**
 * Per-test setup
 */
beforeEach(() => {
  // âš ï¸ DO NOT use fake timers globally - breaks Fastify async operations!
  // Tests that need frozen time should opt-in explicitly with:
  //   vi.useFakeTimers(); vi.setSystemTime(new Date("2025-01-01"));
});

/**
 * Per-test teardown
 */
afterEach(() => {
  // Ensure real timers are restored (in case test used fake timers)
  vi.useRealTimers();
});
