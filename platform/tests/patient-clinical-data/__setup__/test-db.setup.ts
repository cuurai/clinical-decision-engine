/**
 * Test database setup
 *
 * Generated by Test Generator v1.0.0
 * Generator Version: 1.0.0
 * Domain: patient-clinical-data
 *
 * ‚ö†Ô∏è  DO NOT EDIT THIS FILE MANUALLY
 * This file is auto-generated. Any manual changes will be overwritten.
 */


/**
 * Test Database Setup
 *
 * Manages Testcontainers Postgres instance for integration/E2E tests
 */

// @ts-expect-error - Prisma client will be generated when schema is added
import { PrismaClient } from "@prisma/client";
import { PostgreSqlContainer, StartedPostgreSqlContainer } from "@testcontainers/postgresql";
import { execSync } from "child_process";
import path from "path";

let container: StartedPostgreSqlContainer | null = null;
let prisma: PrismaClient | null = null;

/**
 * Get Prisma client instance
 */
export function getPrismaClient(): PrismaClient {
  if (!prisma) {
    throw new Error("Prisma client not initialized. Call startTestDb() first.");
  }
  return prisma;
}

/**
 * Start test database container
 */
export async function startTestDb(): Promise<PrismaClient> {
  if (container) {
    return getPrismaClient();
  }

  console.log("üêò Starting Postgres container...");
  container = await new PostgreSqlContainer()
    .withDatabase("test")
    .withUsername("test")
    .withPassword("test")
    .start();

  const connectionString = container.getConnectionString();

  // Set DATABASE_URL for Prisma
  process.env.DATABASE_URL = connectionString;

  // Run migrations
  console.log("üì¶ Running migrations...");
  execSync("npx prisma migrate deploy", {
    stdio: "inherit",
    env: { ...process.env, DATABASE_URL: connectionString },
  });

  // Initialize Prisma
  prisma = new PrismaClient({
    log: process.env.DEBUG ? ["query", "error"] : ["error"],
  });

  await prisma.$connect();
  console.log("‚úÖ Database ready");

  return prisma;
}

/**
 * Stop test database container
 */
export async function stopTestDb(): Promise<void> {
  if (prisma) {
    await prisma.$disconnect();
    prisma = null;
  }

  if (container) {
    await container.stop();
    container = null;
    console.log("üõë Database stopped");
  }
}
