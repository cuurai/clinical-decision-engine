/**
 * Service entry point
 *
 * Generated by Service Generator v1.0.0
 * Generator Version: 1.0.0
 * Domain: workflow-care-pathways
 *
 * âš ï¸  DO NOT EDIT THIS FILE MANUALLY
 * This file is auto-generated. Any manual changes will be overwritten.
 */

/**
 * WorkflowCarePathways Service - Main Entry Point
 *
 * Environment-specific service startup with:
 * - Prisma database connection
 * - DAO repository wiring
 * - Fastify server initialization
 * - Graceful shutdown handling
 */

// Import Prisma client from adapters-generated client
import { PrismaClient } from "../../../../adapters/src/workflow-care-pathways/prisma/generated/index.js";
import { startService, createDependencies } from "./index.js";
import type { DaoClient } from "@cuur/adapters/shared/dao-client.js";
import {
  DaoAlertAuditEventRepository,
  DaoAlertExplanationRepository,
  DaoAlertRepository,
  DaoCarePathwayTemplateOrderSetTemplateRepository,
  DaoCarePathwayTemplateRepository,
  DaoCarePathwayTemplateStepRepository,
  DaoCarePlanChecklistRepository,
  DaoCarePlanGoalRepository,
  DaoCarePlanRepository,
  DaoCarePlanTaskRepository,
  DaoChecklistInstanceItemRepository,
  DaoChecklistInstanceRepository,
  DaoChecklistTemplateItemRepository,
  DaoChecklistTemplateRepository,
  DaoEpisodeOfCareCarePlanRepository,
  DaoEpisodeOfCareEncounterRepository,
  DaoEpisodeOfCareRepository,
  DaoEpisodeOfCareWorkflowInstanceRepository,
  DaoEpisodesOfCareRepository,
  DaoEscalationPolicyRepository,
  DaoEscalationPolicyRuleRepository,
  DaoHandoffRepository,
  DaoHandoffTaskRepository,
  DaoRoutingRuleRepository,
  DaoScheduleTemplateRepository,
  DaoTaskAssignmentRepository,
  DaoTaskAuditEventRepository,
  DaoTaskCommentRepository,
  DaoTaskRepository,
  DaoWorkQueueAlertRepository,
  DaoWorkQueueRepository,
  DaoWorkQueueTaskRepository,
  DaoWorkflowDefinitionRepository,
  DaoWorkflowDefinitionStateRepository,
  DaoWorkflowDefinitionTransitionRepository,
  DaoWorkflowInstanceAuditEventRepository,
  DaoWorkflowInstanceEventRepository,
  DaoWorkflowInstanceRepository,
  DaoWorkflowInstanceTaskRepository,
} from "@cuur/adapters";

/**
 * Initialize Prisma client with environment-specific configuration
 */
function createPrismaClient(): PrismaClient {
  const isDevelopment = process.env.NODE_ENV === "development";
  const isTest = process.env.NODE_ENV === "test";

  return new PrismaClient({
    log: isDevelopment ? ["query", "info", "warn", "error"] : ["error"],
    errorFormat: isDevelopment ? "pretty" : "minimal",
  });
}

/**
 * Main service startup
 */
async function main() {
  console.log("ğŸš€ Starting WorkflowCarePathways Service...");
  console.log(`   Environment: ${process.env.NODE_ENV || "production"}`);
  console.log(`   Node Version: ${process.version}`);

  // Initialize database connection
  const prisma = createPrismaClient();

  try {
    // Test database connection
    await prisma.$connect();
    console.log("âœ… Database connected");
  } catch (error) {
    console.error("âŒ Database connection failed:", error);
    process.exit(1);
  }

  // Wire up DAO repositories
  // Cast PrismaClient to DaoClient for type compatibility
  const daoClient = prisma as unknown as DaoClient;
  const deps = createDependencies({
    alertAuditEventRepo: new DaoAlertAuditEventRepository(daoClient),
    alertExplanationRepo: new DaoAlertExplanationRepository(daoClient),
    alertRepo: new DaoAlertRepository(daoClient),
    carePathwayTemplateOrderSetTemplateRepo: new DaoCarePathwayTemplateOrderSetTemplateRepository(daoClient),
    carePathwayTemplateRepo: new DaoCarePathwayTemplateRepository(daoClient),
    carePathwayTemplateStepRepo: new DaoCarePathwayTemplateStepRepository(daoClient),
    carePlanChecklistRepo: new DaoCarePlanChecklistRepository(daoClient),
    carePlanGoalRepo: new DaoCarePlanGoalRepository(daoClient),
    carePlanRepo: new DaoCarePlanRepository(daoClient),
    carePlanTaskRepo: new DaoCarePlanTaskRepository(daoClient),
    checklistInstanceItemRepo: new DaoChecklistInstanceItemRepository(daoClient),
    checklistInstanceRepo: new DaoChecklistInstanceRepository(daoClient),
    checklistTemplateItemRepo: new DaoChecklistTemplateItemRepository(daoClient),
    checklistTemplateRepo: new DaoChecklistTemplateRepository(daoClient),
    episodeOfCareCarePlanRepo: new DaoEpisodeOfCareCarePlanRepository(daoClient),
    episodeOfCareEncounterRepo: new DaoEpisodeOfCareEncounterRepository(daoClient),
    episodeOfCareRepo: new DaoEpisodeOfCareRepository(daoClient),
    episodeOfCareWorkflowInstanceRepo: new DaoEpisodeOfCareWorkflowInstanceRepository(daoClient),
    episodesOfCareRepo: new DaoEpisodesOfCareRepository(daoClient),
    escalationPolicyRepo: new DaoEscalationPolicyRepository(daoClient),
    escalationPolicyRuleRepo: new DaoEscalationPolicyRuleRepository(daoClient),
    handoffRepo: new DaoHandoffRepository(daoClient),
    handoffTaskRepo: new DaoHandoffTaskRepository(daoClient),
    routingRuleRepo: new DaoRoutingRuleRepository(daoClient),
    scheduleTemplateRepo: new DaoScheduleTemplateRepository(daoClient),
    taskAssignmentRepo: new DaoTaskAssignmentRepository(daoClient),
    taskAuditEventRepo: new DaoTaskAuditEventRepository(daoClient),
    taskCommentRepo: new DaoTaskCommentRepository(daoClient),
    taskRepo: new DaoTaskRepository(daoClient),
    workQueueAlertRepo: new DaoWorkQueueAlertRepository(daoClient),
    workQueueRepo: new DaoWorkQueueRepository(daoClient),
    workQueueTaskRepo: new DaoWorkQueueTaskRepository(daoClient),
    workflowDefinitionRepo: new DaoWorkflowDefinitionRepository(daoClient),
    workflowDefinitionStateRepo: new DaoWorkflowDefinitionStateRepository(daoClient),
    workflowDefinitionTransitionRepo: new DaoWorkflowDefinitionTransitionRepository(daoClient),
    workflowInstanceAuditEventRepo: new DaoWorkflowInstanceAuditEventRepository(daoClient),
    workflowInstanceEventRepo: new DaoWorkflowInstanceEventRepository(daoClient),
    workflowInstanceRepo: new DaoWorkflowInstanceRepository(daoClient),
    workflowInstanceTaskRepo: new DaoWorkflowInstanceTaskRepository(daoClient),
  });

  // Start Fastify server
  const host = process.env.HOST || "0.0.0.0";
  const port = parseInt(process.env.PORT || "3000", 10);

  const server = await startService(deps, {
    host,
    port,
    logger: process.env.NODE_ENV !== "test",
  });

  // Graceful shutdown
  const shutdown = async (signal: string) => {
    console.log(`\n${signal} received, shutting down gracefully...`);

    try {
      await server.close();
      console.log("âœ… HTTP server closed");

      await prisma.$disconnect();
      console.log("âœ… Database disconnected");

      process.exit(0);
    } catch (error) {
      console.error("âŒ Error during shutdown:", error);
      process.exit(1);
    }
  };

  process.on("SIGTERM", () => shutdown("SIGTERM"));
  process.on("SIGINT", () => shutdown("SIGINT"));
}

// Start the service
main().catch((error) => {
  console.error("âŒ Fatal error:", error);
  process.exit(1);
});
