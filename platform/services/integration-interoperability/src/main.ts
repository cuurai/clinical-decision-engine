/**
 * Service entry point
 *
 * Generated by Service Generator v1.0.0
 * Generator Version: 1.0.0
 * Domain: integration-interoperability
 *
 * âš ï¸  DO NOT EDIT THIS FILE MANUALLY
 * This file is auto-generated. Any manual changes will be overwritten.
 */

/**
 * IntegrationInteroperability Service - Main Entry Point
 *
 * Environment-specific service startup with:
 * - Prisma database connection
 * - DAO repository wiring
 * - Fastify server initialization
 * - Graceful shutdown handling
 */

// Import Prisma client from adapters-generated client
import { PrismaClient } from "../../../../adapters/src/integration-interoperability/prisma/generated/index.js";
import { startService, createDependencies } from "./index.js";
import type { DaoClient } from "@cuur/adapters/shared/dao-client.js";
import {
  DaoAPIClientCredentialRepository,
  DaoAPIClientRepository,
  DaoAPIClientUsageMetricRepository,
  DaoAPICredentialRepository,
  DaoConnectionHealthCheckRepository,
  DaoConnectionIntegrationJobRepository,
  DaoConnectionRepository,
  DaoDataExportBatchErrorRepository,
  DaoDataExportBatchFileRepository,
  DaoDataExportBatchRepository,
  DaoDataImportBatchErrorRepository,
  DaoDataImportBatchRecordRepository,
  DaoDataImportBatchRepository,
  DaoEventDeliveryRepository,
  DaoEventSubscriptionDeliveryRepository,
  DaoEventSubscriptionRepository,
  DaoExternalSystemConnectionRepository,
  DaoExternalSystemEndpointRepository,
  DaoExternalSystemIntegrationJobRepository,
  DaoExternalSystemRepository,
  DaoFHIRBundleRepository,
  DaoFHIRBundleResourceRepository,
  DaoFHIRMappingProfileRepository,
  DaoFHIRMappingProfileRuleRepository,
  DaoHL7MappingProfileRepository,
  DaoHL7MappingProfileRuleRepository,
  DaoHL7MessageMappingResultRepository,
  DaoHL7MessageRepository,
  DaoHL7MessageSegmentRepository,
  DaoIntegrationJobRepository,
  DaoIntegrationJobRunRepository,
  DaoIntegrationRunErrorRepository,
  DaoIntegrationRunLogRepository,
  DaoIntegrationRunRepository,
  DaoInterfaceErrorRepository,
  DaoInterfaceHealthCheckRepository,
} from "@cuur/adapters";

/**
 * Initialize Prisma client with environment-specific configuration
 */
function createPrismaClient(): PrismaClient {
  const isDevelopment = process.env.NODE_ENV === "development";
  const isTest = process.env.NODE_ENV === "test";

  return new PrismaClient({
    log: isDevelopment ? ["query", "info", "warn", "error"] : ["error"],
    errorFormat: isDevelopment ? "pretty" : "minimal",
  });
}

/**
 * Main service startup
 */
async function main() {
  console.log("ğŸš€ Starting IntegrationInteroperability Service...");
  console.log(`   Environment: ${process.env.NODE_ENV || "production"}`);
  console.log(`   Node Version: ${process.version}`);

  // Initialize database connection
  const prisma = createPrismaClient();

  try {
    // Test database connection
    await prisma.$connect();
    console.log("âœ… Database connected");
  } catch (error) {
    console.error("âŒ Database connection failed:", error);
    process.exit(1);
  }

  // Wire up DAO repositories
  // Cast PrismaClient to DaoClient for type compatibility
  const daoClient = prisma as unknown as DaoClient;
  const deps = createDependencies({
    aPIClientCredentialRepo: new DaoAPIClientCredentialRepository(daoClient),
    aPIClientRepo: new DaoAPIClientRepository(daoClient),
    aPIClientUsageMetricRepo: new DaoAPIClientUsageMetricRepository(daoClient),
    aPICredentialRepo: new DaoAPICredentialRepository(daoClient),
    connectionHealthCheckRepo: new DaoConnectionHealthCheckRepository(daoClient),
    connectionIntegrationJobRepo: new DaoConnectionIntegrationJobRepository(daoClient),
    connectionRepo: new DaoConnectionRepository(daoClient),
    dataExportBatchErrorRepo: new DaoDataExportBatchErrorRepository(daoClient),
    dataExportBatchFileRepo: new DaoDataExportBatchFileRepository(daoClient),
    dataExportBatchRepo: new DaoDataExportBatchRepository(daoClient),
    dataImportBatchErrorRepo: new DaoDataImportBatchErrorRepository(daoClient),
    dataImportBatchRecordRepo: new DaoDataImportBatchRecordRepository(daoClient),
    dataImportBatchRepo: new DaoDataImportBatchRepository(daoClient),
    eventDeliveryRepo: new DaoEventDeliveryRepository(daoClient),
    eventSubscriptionDeliveryRepo: new DaoEventSubscriptionDeliveryRepository(daoClient),
    eventSubscriptionRepo: new DaoEventSubscriptionRepository(daoClient),
    externalSystemConnectionRepo: new DaoExternalSystemConnectionRepository(daoClient),
    externalSystemEndpointRepo: new DaoExternalSystemEndpointRepository(daoClient),
    externalSystemIntegrationJobRepo: new DaoExternalSystemIntegrationJobRepository(daoClient),
    externalSystemRepo: new DaoExternalSystemRepository(daoClient),
    fHIRBundleRepo: new DaoFHIRBundleRepository(daoClient),
    fHIRBundleResourceRepo: new DaoFHIRBundleResourceRepository(daoClient),
    fHIRMappingProfileRepo: new DaoFHIRMappingProfileRepository(daoClient),
    fHIRMappingProfileRuleRepo: new DaoFHIRMappingProfileRuleRepository(daoClient),
    hLMappingProfileRepo: new DaoHL7MappingProfileRepository(daoClient),
    hLMappingProfileRuleRepo: new DaoHL7MappingProfileRuleRepository(daoClient),
    hLMessageMappingResultRepo: new DaoHL7MessageMappingResultRepository(daoClient),
    hLMessageRepo: new DaoHL7MessageRepository(daoClient),
    hLMessageSegmentRepo: new DaoHL7MessageSegmentRepository(daoClient),
    integrationJobRepo: new DaoIntegrationJobRepository(daoClient),
    integrationJobRunRepo: new DaoIntegrationJobRunRepository(daoClient),
    integrationRunErrorRepo: new DaoIntegrationRunErrorRepository(daoClient),
    integrationRunLogRepo: new DaoIntegrationRunLogRepository(daoClient),
    integrationRunRepo: new DaoIntegrationRunRepository(daoClient),
    interfaceErrorRepo: new DaoInterfaceErrorRepository(daoClient),
    interfaceHealthCheckRepo: new DaoInterfaceHealthCheckRepository(daoClient),
  });

  // Start Fastify server
  const host = process.env.HOST || "0.0.0.0";
  const port = parseInt(process.env.PORT || "3000", 10);

  const server = await startService(deps, {
    host,
    port,
    logger: process.env.NODE_ENV !== "test",
  });

  // Graceful shutdown
  const shutdown = async (signal: string) => {
    console.log(`\n${signal} received, shutting down gracefully...`);

    try {
      await server.close();
      console.log("âœ… HTTP server closed");

      await prisma.$disconnect();
      console.log("âœ… Database disconnected");

      process.exit(0);
    } catch (error) {
      console.error("âŒ Error during shutdown:", error);
      process.exit(1);
    }
  };

  process.on("SIGTERM", () => shutdown("SIGTERM"));
  process.on("SIGINT", () => shutdown("SIGINT"));
}

// Start the service
main().catch((error) => {
  console.error("âŒ Fatal error:", error);
  process.exit(1);
});
