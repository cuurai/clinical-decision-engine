/**
 * Service entry point
 *
 * Generated by Service Generator v1.0.0
 * Generator Version: 1.0.0
 * Domain: knowledge-evidence
 *
 * âš ï¸  DO NOT EDIT THIS FILE MANUALLY
 * This file is auto-generated. Any manual changes will be overwritten.
 */

/**
 * KnowledgeEvidence Service - Main Entry Point
 *
 * Environment-specific service startup with:
 * - Prisma database connection
 * - DAO repository wiring
 * - Fastify server initialization
 * - Graceful shutdown handling
 */

// Import Prisma client from adapters-generated client
import { prisma } from "@cde/db";
import { startService, createDependencies } from "./index.js";
import type { DaoClient } from "@cuur/adapters-shared";
import {
  DaoCareProtocolOrderSetRepository,
  DaoCareProtocolRepository,
  DaoCareProtocolStepRepository,
  DaoClinicalRuleRepository,
  DaoClinicalRuleTestRepository,
  DaoClinicalRuleVersionRepository,
  DaoConceptMapMappingRepository,
  DaoConceptMapRepository,
  DaoEvidenceCitationRepository,
  DaoEvidenceReviewRepository,
  DaoGuidelineEvidenceCitationRepository,
  DaoGuidelineRepository,
  DaoGuidelineSectionRepository,
  DaoKnowledgePackageClinicalRuleRepository,
  DaoKnowledgePackageModelDefinitionRepository,
  DaoKnowledgePackageRepository,
  DaoKnowledgePackageValueSetRepository,
  DaoModelDefinitionPerformanceMetricRepository,
  DaoModelDefinitionRepository,
  DaoModelDefinitionVersionRepository,
  DaoModelVersionFeatureDefinitionRepository,
  DaoModelVersionRepository,
  DaoModelVersionTestRepository,
  DaoOntologyTermChildRepository,
  DaoOntologyTermMappingRepository,
  DaoOntologyTermParentRepository,
  DaoOntologyTermRepository,
  DaoOrderSetTemplateItemRepository,
  DaoOrderSetTemplateRepository,
  DaoQuestionnaireTemplateQuestionRepository,
  DaoQuestionnaireTemplateRepository,
  DaoRuleSetClinicalRuleRepository,
  DaoRuleSetRepository,
  DaoScoringTemplateItemRepository,
  DaoScoringTemplateRepository,
  DaoValueSetCodeRepository,
  DaoValueSetRepository,
} from "@cuur/adapters-knowledge-evidence";

/**
 * Initialize Prisma client with environment-specific configuration
 */

/**
 * Main service startup
 */
async function main() {
  console.log("ğŸš€ Starting KnowledgeEvidence Service...");
  console.log(`   Environment: ${process.env.NODE_ENV || "production"}`);
  console.log(`   Node Version: ${process.version}`);

  // Initialize database connection
  // Using shared Prisma client from @cde/db

  try {
    // Test database connection
    await prisma.$connect();
    console.log("âœ… Database connected");
  } catch (error) {
    console.error("âŒ Database connection failed:", error);
    process.exit(1);
  }

  // Wire up DAO repositories
  // Cast PrismaClient to DaoClient for type compatibility
  const daoClient = prisma as unknown as DaoClient;
  const deps = createDependencies({
    careProtocolOrderSetRepo: new DaoCareProtocolOrderSetRepository(daoClient),
    careProtocolRepo: new DaoCareProtocolRepository(daoClient),
    careProtocolStepRepo: new DaoCareProtocolStepRepository(daoClient),
    clinicalRuleRepo: new DaoClinicalRuleRepository(daoClient),
    clinicalRuleTestRepo: new DaoClinicalRuleTestRepository(daoClient),
    clinicalRuleVersionRepo: new DaoClinicalRuleVersionRepository(daoClient),
    conceptMapMappingRepo: new DaoConceptMapMappingRepository(daoClient),
    conceptMapRepo: new DaoConceptMapRepository(daoClient),
    evidenceCitationRepo: new DaoEvidenceCitationRepository(daoClient),
    evidenceReviewRepo: new DaoEvidenceReviewRepository(daoClient),
    guidelineEvidenceCitationRepo: new DaoGuidelineEvidenceCitationRepository(daoClient),
    guidelineRepo: new DaoGuidelineRepository(daoClient),
    guidelineSectionRepo: new DaoGuidelineSectionRepository(daoClient),
    knowledgePackageClinicalRuleRepo: new DaoKnowledgePackageClinicalRuleRepository(daoClient),
    knowledgePackageModelDefinitionRepo: new DaoKnowledgePackageModelDefinitionRepository(daoClient),
    knowledgePackageRepo: new DaoKnowledgePackageRepository(daoClient),
    knowledgePackageValueSetRepo: new DaoKnowledgePackageValueSetRepository(daoClient),
    modelDefinitionPerformanceMetricRepo: new DaoModelDefinitionPerformanceMetricRepository(daoClient),
    modelDefinitionRepo: new DaoModelDefinitionRepository(daoClient),
    modelDefinitionVersionRepo: new DaoModelDefinitionVersionRepository(daoClient),
    modelVersionFeatureDefinitionRepo: new DaoModelVersionFeatureDefinitionRepository(daoClient),
    modelVersionRepo: new DaoModelVersionRepository(daoClient),
    modelVersionTestRepo: new DaoModelVersionTestRepository(daoClient),
    ontologyTermChildRepo: new DaoOntologyTermChildRepository(daoClient),
    ontologyTermMappingRepo: new DaoOntologyTermMappingRepository(daoClient),
    ontologyTermParentRepo: new DaoOntologyTermParentRepository(daoClient),
    ontologyTermRepo: new DaoOntologyTermRepository(daoClient),
    orderSetTemplateItemRepo: new DaoOrderSetTemplateItemRepository(daoClient),
    orderSetTemplateRepo: new DaoOrderSetTemplateRepository(daoClient),
    questionnaireTemplateQuestionRepo: new DaoQuestionnaireTemplateQuestionRepository(daoClient),
    questionnaireTemplateRepo: new DaoQuestionnaireTemplateRepository(daoClient),
    ruleSetClinicalRuleRepo: new DaoRuleSetClinicalRuleRepository(daoClient),
    ruleSetRepo: new DaoRuleSetRepository(daoClient),
    scoringTemplateItemRepo: new DaoScoringTemplateItemRepository(daoClient),
    scoringTemplateRepo: new DaoScoringTemplateRepository(daoClient),
    valueSetCodeRepo: new DaoValueSetCodeRepository(daoClient),
    valueSetRepo: new DaoValueSetRepository(daoClient),
  });

  // Start Fastify server
  const host = process.env.HOST || "0.0.0.0";
  const port = parseInt(process.env.PORT || "3000", 10);

  const server = await startService(deps, {
    host,
    port,
    logger: process.env.NODE_ENV !== "test",
  });

  // Graceful shutdown
  const shutdown = async (signal: string) => {
    console.log(`\n${signal} received, shutting down gracefully...`);

    try {
      await server.close();
      console.log("âœ… HTTP server closed");

      await prisma.$disconnect();
      console.log("âœ… Database disconnected");

      process.exit(0);
    } catch (error) {
      console.error("âŒ Error during shutdown:", error);
      process.exit(1);
    }
  };

  process.on("SIGTERM", () => shutdown("SIGTERM"));
  process.on("SIGINT", () => shutdown("SIGINT"));
}

// Start the service
main().catch((error) => {
  console.error("âŒ Fatal error:", error);
  process.exit(1);
});
