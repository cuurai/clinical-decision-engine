/**
 * Service entry point
 *
 * Generated by Service Generator v1.0.0
 * Generator Version: 1.0.0
 * Domain: patient-clinical-data
 *
 * âš ï¸  DO NOT EDIT THIS FILE MANUALLY
 * This file is auto-generated. Any manual changes will be overwritten.
 */

/**
 * PatientClinicalData Service - Main Entry Point
 *
 * Environment-specific service startup with:
 * - Prisma database connection
 * - DAO repository wiring
 * - Fastify server initialization
 * - Graceful shutdown handling
 */

// Import Prisma client from adapters-generated client
import { prisma } from "@cuur-cde/db";
import { startService, createDependencies } from "./index.js";
import type { DaoClient } from "./db/dao-client.js";
import {
  DaoAllergyRepository,
  DaoCareTeamRepository,
  DaoConditionNoteRepository,
  DaoConditionRepository,
  DaoDiagnosticReportImagingStudyRepository,
  DaoDiagnosticReportObservationRepository,
  DaoDiagnosticReportRepository,
  DaoDocumentRepository,
  DaoEncounterConditionRepository,
  DaoEncounterDiagnosticReportRepository,
  DaoEncounterNoteRepository,
  DaoEncounterObservationRepository,
  DaoEncounterProcedureRepository,
  DaoEncounterRepository,
  DaoImagingStudyRepository,
  DaoImagingStudySeriesRepository,
  DaoImmunizationRepository,
  DaoMedicationAdministrationRepository,
  DaoMedicationOrderRepository,
  DaoMedicationStatementRepository,
  DaoNoteRepository,
  DaoObservationRepository,
  DaoPatientAllergyRepository,
  DaoPatientCareTeamRepository,
  DaoPatientConditionRepository,
  DaoPatientDiagnosticReportRepository,
  DaoPatientDocumentRepository,
  DaoPatientEncounterRepository,
  DaoPatientImmunizationRepository,
  DaoPatientLabRepository,
  DaoPatientMedicationRepository,
  DaoPatientNoteRepository,
  DaoPatientObservationRepository,
  DaoPatientProcedureRepository,
  DaoPatientRepository,
  DaoPatientSummaryRepository,
  DaoPatientVitalRepository,
  DaoProcedureRepository,
} from "@cuur/adapters-patient-clinical-data";

/**
 * Initialize Prisma client with environment-specific configuration
 */

/**
 * Main service startup
 */
async function main() {
  console.log("ğŸš€ Starting PatientClinicalData Service...");
  console.log(`   Environment: ${process.env.NODE_ENV || "production"}`);
  console.log(`   Node Version: ${process.version}`);

  // Initialize database connection
  // Using shared Prisma client from @cuur-cde/db

  try {
    // Test database connection
    await prisma.$connect();
    console.log("âœ… Database connected");
  } catch (error) {
    console.error("âŒ Database connection failed:", error);
    process.exit(1);
  }

  // Wire up DAO repositories
  // Cast PrismaClient to DaoClient for type compatibility
  const daoClient = prisma as unknown as DaoClient;
  const deps = createDependencies({
    allergyRepo: new DaoAllergyRepository(daoClient),
    careTeamRepo: new DaoCareTeamRepository(daoClient),
    conditionNoteRepo: new DaoConditionNoteRepository(daoClient),
    conditionRepo: new DaoConditionRepository(daoClient),
    diagnosticReportImagingStudyRepo: new DaoDiagnosticReportImagingStudyRepository(daoClient),
    diagnosticReportObservationRepo: new DaoDiagnosticReportObservationRepository(daoClient),
    diagnosticReportRepo: new DaoDiagnosticReportRepository(daoClient),
    documentRepo: new DaoDocumentRepository(daoClient),
    encounterConditionRepo: new DaoEncounterConditionRepository(daoClient),
    encounterDiagnosticReportRepo: new DaoEncounterDiagnosticReportRepository(daoClient),
    encounterNoteRepo: new DaoEncounterNoteRepository(daoClient),
    encounterObservationRepo: new DaoEncounterObservationRepository(daoClient),
    encounterProcedureRepo: new DaoEncounterProcedureRepository(daoClient),
    encounterRepo: new DaoEncounterRepository(daoClient),
    imagingStudyRepo: new DaoImagingStudyRepository(daoClient),
    imagingStudySeriesRepo: new DaoImagingStudySeriesRepository(daoClient),
    immunizationRepo: new DaoImmunizationRepository(daoClient),
    medicationAdministrationRepo: new DaoMedicationAdministrationRepository(daoClient),
    medicationOrderRepo: new DaoMedicationOrderRepository(daoClient),
    medicationStatementRepo: new DaoMedicationStatementRepository(daoClient),
    noteRepo: new DaoNoteRepository(daoClient),
    observationRepo: new DaoObservationRepository(daoClient),
    patientAllergyRepo: new DaoPatientAllergyRepository(daoClient),
    patientCareTeamRepo: new DaoPatientCareTeamRepository(daoClient),
    patientConditionRepo: new DaoPatientConditionRepository(daoClient),
    patientDiagnosticReportRepo: new DaoPatientDiagnosticReportRepository(daoClient),
    patientDocumentRepo: new DaoPatientDocumentRepository(daoClient),
    patientEncounterRepo: new DaoPatientEncounterRepository(daoClient),
    patientImmunizationRepo: new DaoPatientImmunizationRepository(daoClient),
    patientLabRepo: new DaoPatientLabRepository(daoClient),
    patientMedicationRepo: new DaoPatientMedicationRepository(daoClient),
    patientNoteRepo: new DaoPatientNoteRepository(daoClient),
    patientObservationRepo: new DaoPatientObservationRepository(daoClient),
    patientProcedureRepo: new DaoPatientProcedureRepository(daoClient),
    patientRepo: new DaoPatientRepository(daoClient),
    patientSummaryRepo: new DaoPatientSummaryRepository(daoClient),
    patientVitalRepo: new DaoPatientVitalRepository(daoClient),
    procedureRepo: new DaoProcedureRepository(daoClient),
  });

  // Start Fastify server
  const host = process.env.HOST || "0.0.0.0";
  const port = parseInt(process.env.PORT || "3000", 10);

  const server = await startService(deps, {
    host,
    port,
    logger: process.env.NODE_ENV !== "test",
  });

  // Graceful shutdown
  const shutdown = async (signal: string) => {
    console.log(`\n${signal} received, shutting down gracefully...`);

    try {
      await server.close();
      console.log("âœ… HTTP server closed");

      await prisma.$disconnect();
      console.log("âœ… Database disconnected");

      process.exit(0);
    } catch (error) {
      console.error("âŒ Error during shutdown:", error);
      process.exit(1);
    }
  };

  process.on("SIGTERM", () => shutdown("SIGTERM"));
  process.on("SIGINT", () => shutdown("SIGINT"));
}

// Start the service
main().catch((error) => {
  console.error("âŒ Fatal error:", error);
  process.exit(1);
});
