/**
 * Service entry point with Fastify server
 *
 * Generated by Service Generator v1.0.0
 * Generator Version: 1.0.0
 * Domain: decision-intelligence
 *
 * ‚ö†Ô∏è  DO NOT EDIT THIS FILE MANUALLY
 * This file is auto-generated. Any manual changes will be overwritten.
 */

import Fastify from "fastify";
import type { FastifyInstance } from "fastify";
import cors from "@fastify/cors";
import { registerRoutes } from "./routes/index.js";
import { createDependencies } from "./dependencies/decision-intelligence.dependencies.js";
import type { Dependencies } from "./dependencies/decision-intelligence.dependencies.js";

/**
 * Service configuration
 */
export interface ServiceConfig {
  host?: string;
  port?: number;
  logger?: boolean;
}

/**
 * Create and configure Fastify server
 */
export async function createServer(
  deps: Dependencies,
  config: ServiceConfig = {}
): Promise<FastifyInstance> {
  const fastify = Fastify({
    logger: config.logger ?? true,
  });

  // Register CORS
  await fastify.register(cors, {
    origin: true, // Allow all origins for now (can be restricted later)
    credentials: true,
    methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"],
    allowedHeaders: ["Content-Type", "Authorization", "X-Org-Id"],
  });

  // Register routes
  await registerRoutes(fastify, deps);

  // Health check
  fastify.get("/health", async () => {
    return {
      status: "ok",
      service: "decision-intelligence",
      version: "1.0.0",
      timestamp: new Date().toISOString(),
    };
  });

  return fastify;
}

/**
 * Start the service
 */
export async function startService(deps: Dependencies, config: ServiceConfig = {}) {
  const host = config.host ?? "0.0.0.0";
  const port = config.port ?? 3000;

  const server = await createServer(deps, config);

  try {
    await server.listen({ host, port });
    console.log(`üöÄ decision-intelligence service listening on http://${host}:${port}`);
  } catch (err) {
    server.log.error(err);
    process.exit(1);
  }

  return server;
}

// Re-export types
export type { Dependencies } from "./dependencies/decision-intelligence.dependencies.js";
export { createDependencies } from "./dependencies/decision-intelligence.dependencies.js";
