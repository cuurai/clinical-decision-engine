/**
 * Service entry point
 *
 * Generated by Service Generator v1.0.0
 * Generator Version: 1.0.0
 * Domain: decision-intelligence
 *
 * âš ï¸  DO NOT EDIT THIS FILE MANUALLY
 * This file is auto-generated. Any manual changes will be overwritten.
 */

/**
 * DecisionIntelligence Service - Main Entry Point
 *
 * Environment-specific service startup with:
 * - Prisma database connection
 * - DAO repository wiring
 * - Fastify server initialization
 * - Graceful shutdown handling
 */

// Import Prisma client from adapters-generated client
import { PrismaClient } from "@prisma/client";
import { startService, createDependencies } from "./index.js";
import type { DaoClient } from "@cuur/adapters-shared/dao-client.js";
import {
  DaoAlertEvaluationRepository,
  DaoDecisionMetricRepository,
  DaoDecisionPolicyRepository,
  DaoDecisionPolicyThresholdProfileRepository,
  DaoDecisionRequestExplanationRepository,
  DaoDecisionRequestRepository,
  DaoDecisionRequestResultRepository,
  DaoDecisionResultExplanationRepository,
  DaoDecisionResultRecommendationRepository,
  DaoDecisionResultRepository,
  DaoDecisionResultRiskAssessmentRepository,
  DaoDecisionSessionAlertRepository,
  DaoDecisionSessionExplanationRepository,
  DaoDecisionSessionRepository,
  DaoDecisionSessionRequestRepository,
  DaoDecisionSessionResultRepository,
  DaoDecisionSessionRiskAssessmentRepository,
  DaoExperimentArmRepository,
  DaoExperimentRepository,
  DaoExperimentResultRepository,
  DaoExplanationFeatureRepository,
  DaoExplanationRepository,
  DaoExplanationRuleTraceRepository,
  DaoModelInvocationExplanationRepository,
  DaoModelInvocationRepository,
  DaoRecommendationExplanationRepository,
  DaoRecommendationRepository,
  DaoRiskAssessmentExplanationRepository,
  DaoRiskAssessmentRepository,
  DaoSimulationRunDecisionResultRepository,
  DaoSimulationRunMetricRepository,
  DaoSimulationRunRepository,
  DaoSimulationScenarioRepository,
  DaoSimulationScenarioRunRepository,
  DaoThresholdProfileRepository,
} from "@cuur/adapters-decision-intelligence";

/**
 * Initialize Prisma client with environment-specific configuration
 */
function createPrismaClient(): PrismaClient {
  const isDevelopment = process.env.NODE_ENV === "development";
  const isTest = process.env.NODE_ENV === "test";

  return new PrismaClient({
    log: isDevelopment ? ["query", "info", "warn", "error"] : ["error"],
    errorFormat: isDevelopment ? "pretty" : "minimal",
  });
}

/**
 * Main service startup
 */
async function main() {
  console.log("ğŸš€ Starting DecisionIntelligence Service...");
  console.log(`   Environment: ${process.env.NODE_ENV || "production"}`);
  console.log(`   Node Version: ${process.version}`);

  // Initialize database connection
  const prisma = createPrismaClient();

  try {
    // Test database connection
    await prisma.$connect();
    console.log("âœ… Database connected");
  } catch (error) {
    console.error("âŒ Database connection failed:", error);
    process.exit(1);
  }

  // Wire up DAO repositories
  // Cast PrismaClient to DaoClient for type compatibility
  const daoClient = prisma as unknown as DaoClient;
  const deps = createDependencies({
    alertEvaluationRepo: new DaoAlertEvaluationRepository(daoClient),
    decisionMetricRepo: new DaoDecisionMetricRepository(daoClient),
    decisionPolicyRepo: new DaoDecisionPolicyRepository(daoClient),
    decisionPolicyThresholdProfileRepo: new DaoDecisionPolicyThresholdProfileRepository(daoClient),
    decisionRequestExplanationRepo: new DaoDecisionRequestExplanationRepository(daoClient),
    decisionRequestRepo: new DaoDecisionRequestRepository(daoClient),
    decisionRequestResultRepo: new DaoDecisionRequestResultRepository(daoClient),
    decisionResultExplanationRepo: new DaoDecisionResultExplanationRepository(daoClient),
    decisionResultRecommendationRepo: new DaoDecisionResultRecommendationRepository(daoClient),
    decisionResultRepo: new DaoDecisionResultRepository(daoClient),
    decisionResultRiskAssessmentRepo: new DaoDecisionResultRiskAssessmentRepository(daoClient),
    decisionSessionAlertRepo: new DaoDecisionSessionAlertRepository(daoClient),
    decisionSessionExplanationRepo: new DaoDecisionSessionExplanationRepository(daoClient),
    decisionSessionRepo: new DaoDecisionSessionRepository(daoClient),
    decisionSessionRequestRepo: new DaoDecisionSessionRequestRepository(daoClient),
    decisionSessionResultRepo: new DaoDecisionSessionResultRepository(daoClient),
    decisionSessionRiskAssessmentRepo: new DaoDecisionSessionRiskAssessmentRepository(daoClient),
    experimentArmRepo: new DaoExperimentArmRepository(daoClient),
    experimentRepo: new DaoExperimentRepository(daoClient),
    experimentResultRepo: new DaoExperimentResultRepository(daoClient),
    explanationFeatureRepo: new DaoExplanationFeatureRepository(daoClient),
    explanationRepo: new DaoExplanationRepository(daoClient),
    explanationRuleTraceRepo: new DaoExplanationRuleTraceRepository(daoClient),
    modelInvocationExplanationRepo: new DaoModelInvocationExplanationRepository(daoClient),
    modelInvocationRepo: new DaoModelInvocationRepository(daoClient),
    recommendationExplanationRepo: new DaoRecommendationExplanationRepository(daoClient),
    recommendationRepo: new DaoRecommendationRepository(daoClient),
    riskAssessmentExplanationRepo: new DaoRiskAssessmentExplanationRepository(daoClient),
    riskAssessmentRepo: new DaoRiskAssessmentRepository(daoClient),
    simulationRunDecisionResultRepo: new DaoSimulationRunDecisionResultRepository(daoClient),
    simulationRunMetricRepo: new DaoSimulationRunMetricRepository(daoClient),
    simulationRunRepo: new DaoSimulationRunRepository(daoClient),
    simulationScenarioRepo: new DaoSimulationScenarioRepository(daoClient),
    simulationScenarioRunRepo: new DaoSimulationScenarioRunRepository(daoClient),
    thresholdProfileRepo: new DaoThresholdProfileRepository(daoClient),
  });

  // Start Fastify server
  const host = process.env.HOST || "0.0.0.0";
  const port = parseInt(process.env.PORT || "3000", 10);

  const server = await startService(deps, {
    host,
    port,
    logger: process.env.NODE_ENV !== "test",
  });

  // Graceful shutdown
  const shutdown = async (signal: string) => {
    console.log(`\n${signal} received, shutting down gracefully...`);

    try {
      await server.close();
      console.log("âœ… HTTP server closed");

      await prisma.$disconnect();
      console.log("âœ… Database disconnected");

      process.exit(0);
    } catch (error) {
      console.error("âŒ Error during shutdown:", error);
      process.exit(1);
    }
  };

  process.on("SIGTERM", () => shutdown("SIGTERM"));
  process.on("SIGINT", () => shutdown("SIGINT"));
}

// Start the service
main().catch((error) => {
  console.error("âŒ Fatal error:", error);
  process.exit(1);
});
