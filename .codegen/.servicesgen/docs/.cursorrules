# Cursor Agent Instructions for ServicesGen

## ServicesGen CLI Usage

**⚠️ CRITICAL: Always use the proper CLI command `quub-codegen`. NEVER use primitive methods.**

### ✅ CORRECT Usage

```bash
# Generate all orchestrator domains
quub-codegen generate --all --layer orchestrators --no-build

# Generate specific orchestrator domain
quub-codegen generate --domain trading-markets --layer orchestrators --no-build

# Generate raw domain layers (services, adapters, tests, prisma)
quub-codegen generate --all --layer services --layer adapters --layer tests --layer prisma --no-build

# Generate all layers
quub-codegen generate --all --layer all --no-build

# Works from any directory - path resolution is automatic
cd platform
quub-codegen generate --domain accounts-funding --layer orchestrators --no-build
```

### ❌ WRONG - Never Use These

```bash
# DON'T use PYTHONPATH workarounds
PYTHONPATH=.servicesgen/src python3 -m quub_codegen.cli.main generate --all

# DON'T run Python modules directly
python3 -m quub_codegen.cli.main generate --all

# DON'T use relative imports
cd .servicesgen && python3 -m quub_codegen.cli.main generate --all
```

### Key Points

1. **Always use `quub-codegen` command** - It's installed via `pip install -e .` in `.servicesgen/`
2. **Works from any directory** - The CLI automatically detects project root and config file
3. **Path resolution is automatic** - No need to worry about relative paths
4. **Use `--no-build` flag** - Skip build validation during generation (faster)
5. **Config file location** - Default searches: `.quub-codegen.json`, `platform/.quub-codegen.json`
6. **Layer options** - Use `--layer services`, `--layer adapters`, `--layer tests`, `--layer prisma`, `--layer orchestrators`, or `--layer all`
7. **Domain config files** - Located in `.servicesgen/config/`:
   - `.raw-domains.yaml` - Raw domain definitions (used by services, adapters, tests, prisma)
   - `.orchestrator-domains.yaml` - Orchestrator domain definitions (used by orchestrators layer)

### Installation

If `quub-codegen` command is not found:

```bash
cd .servicesgen
pip install -e .
```

### Verification

```bash
quub-codegen --version
quub-codegen --help
```

### Full Documentation

See `.servicesgen/docs/AI_AGENT_USAGE.md` for complete usage guide.
See `.servicesgen/docs/AI_AGENT_MAINTENANCE.md` for comprehensive maintenance guide.

## Project Structure

- `.servicesgen/` - Code generation tooling (services, adapters, tests, prisma, orchestrators)
- `platform/` - Generated code (services, adapters, tests, prisma, orchestrators)
- `packages/core/` - Core SDK code (generated by `.codegen`)
- `.servicesgen/config/` - Centralized configuration files (raw domains, orchestrator domains)
- `platform/orchestrators/openapi/src/yaml/` - Orchestrator OpenAPI YAML specifications

## ServicesGen Output Structure

All generated files go into `platform/` directory:

```
platform/
├── services/src/              # Generated service routes, dependencies (raw domains)
├── adapters/src/              # Generated DAO repository implementations (raw domains)
├── tests/src/                 # Generated test suites, mocks, factories (raw domains)
└── orchestrators/
    ├── domains/src/           # Generated orchestrator domains
    │   └── {domain}/
    │       ├── flows/         # Business workflow files (*.flow.ts)
    │       ├── routes.ts      # API Gateway route → flow mapping
    │       ├── handler.ts     # Lambda entrypoint
    │       ├── deps.ts        # Dependency injection (DAO repositories)
    │       ├── context.ts     # Request context extraction (JWT)
    │       ├── logger.ts     # Structured logging (pino)
    │       ├── errors/        # Error handling (FlowError)
    │       ├── config/        # Environment/config loaders
    │       ├── package.json   # Package configuration
    │       └── tsconfig.json  # TypeScript configuration
    └── openapi/src/yaml/      # Orchestrator OpenAPI YAML specs (input)
```

## Orchestrator Architecture

### Key Principles

1. **Direct Handler Calls** - Orchestrators import and call core handlers directly from `@quub/core`. No service clients or HTTP calls.
2. **JWT-Based Security** - `orgId` and `accountId` are extracted from JWT context, NEVER from URL parameters.
3. **Request Validation** - Uses core Zod schemas from `@quub/core` for request body validation.
4. **DAO Integration** - Uses DAO repositories from `@quub/adapters` for direct database access.
5. **Modular Structure** - Each orchestrator domain is self-contained with flows, routes, deps, and handlers.

### Orchestrator Domain Structure

Each orchestrator domain (`platform/orchestrators/domains/src/{domain}/`) contains:

- **`flows/*.flow.ts`** - Business workflow files that orchestrate multiple core handler calls
- **`routes.ts`** - Maps API Gateway events to flow handlers using path-to-regexp
- **`handler.ts`** - Lambda entrypoint that extracts JWT context and routes requests
- **`deps.ts`** - Dependency injection container (auto-discovers required DAO repositories)
- **`context.ts`** - JWT context extraction utilities
- **`logger.ts`** - Structured logging setup (pino)
- **`errors/flow-error.ts`** - Custom FlowError class for consistent error responses
- **`config/index.ts`** - Environment and configuration loaders
- **`package.json`** - Package configuration with dependencies
- **`tsconfig.json`** - TypeScript configuration with proper path mappings

### Flow Files

Flow files (`flows/*.flow.ts`) contain business workflows that:

1. Extract `orgId` and `accountId` from JWT context (never from URL)
2. Validate request body using core Zod schemas (e.g., `exchangeSchemas.CreateOrderRequest.parse(body)`)
3. Call core handlers directly (e.g., `createOrder(deps.orderRepo, orgId, validatedBody)`)
4. Use DAO repositories for database access when needed
5. Compose responses from multiple handler calls
6. Handle errors consistently using `FlowError`

### Validation

- **Schema Naming**: Core exports schemas with naming pattern: remove hyphens, keep lowercase, add "Schemas"
  - `fiat-banking` → `fiatbankingSchemas`
  - `risk-limits` → `risklimitsSchemas`
  - `exchange` → `exchangeSchemas`
- **Import Pattern**: `import { {domain}Schemas } from "@quub/core/{domain}/index.js";`
- **Usage**: `const validatedBody = {domain}Schemas.{SchemaName}Request.parse(body);`

### DAO Repositories

- **Auto-Discovery**: `deps.ts` automatically discovers required DAO repositories by analyzing handlers used in flows
- **Import Pattern**: `import { Dao{Resource}Repository } from "@quub/adapters";`
- **Usage**: Pass repositories to core handlers (e.g., `createOrder(deps.orderRepo, orgId, body)`)

### TypeScript Configuration

- **baseUrl**: Set to `../../..` (points to `platform/`)
- **Path Mappings**:
  - `@quub/core`: `["../packages/core/packages/core/dist/index.d.ts", "../packages/core/packages/core/src/index.ts"]`
  - `@quub/core/*`: `["../packages/core/packages/core/src/*", "../packages/core/packages/core/dist/*"]`
  - `@quub/adapters`: `["adapters/src/index.ts"]`
  - `@quub/adapters/*`: `["adapters/src/*"]`

## Code Generation Workflow

1. **Install servicesgen** (if needed): `cd .servicesgen && pip install -e .`
2. **Generate core package** (if needed): `cd .codegen && quub-coregen generate --all --no-build`
3. **Generate raw domain layers** (services, adapters, tests, prisma):
   ```bash
   quub-codegen generate --all --layer services --layer adapters --layer tests --layer prisma --no-build
   ```
4. **Generate orchestrator domains**:
   ```bash
   quub-codegen generate --all --layer orchestrators --no-build
   ```
5. **Or generate all layers at once**:
   ```bash
   quub-codegen generate --all --layer all --no-build
   ```
6. **Verify**: Check for generated files in `platform/` directory

## Important Notes

- ServicesGen is **TOTALLY INDEPENDENT** from `.codegen` but follows the same design principles
- ServicesGen expects **pre-bundled** OpenAPI specs for raw domains (no bundling in servicesgen)
- Orchestrators read from **YAML OpenAPI specs** in `platform/orchestrators/openapi/src/yaml/`
- All generated files are in `platform/` directory
- Never manually edit generated files - they will be overwritten
- **Layers generated by ServicesGen**:
  - **Raw domain layers**: `services`, `adapters`, `tests`, `prisma` (for technical service domains)
  - **Orchestrator layer**: `orchestrators` (business-scenario-driven API aggregation layer)
- **Configuration files**: Domain definitions are centralized in `.servicesgen/config/`:
  - `.raw-domains.yaml` - Lists all raw domains (used by services, adapters, tests, prisma)
  - `.orchestrator-domains.yaml` - Maps orchestrator domains to raw domains (used by orchestrators)
- ServicesGen does NOT generate core generators (handlers, types, validators, schemas) - those belong to `.codegen`
- **Orchestrators call handlers directly** - No service clients, no HTTP calls, no domain wrappers

## Common Tasks

### Regenerate All Orchestrators

```bash
quub-codegen generate --all --layer orchestrators --no-build
```

### Regenerate Specific Orchestrator Domain

```bash
quub-codegen generate --domain trading-markets --layer orchestrators --no-build
```

### Update Handler Names in YAML Files

Use the script to update handler names based on actual core handler exports:

```bash
cd .servicesgen
python scripts/update_yaml_handlers.py
```

### Fix Linting Errors

After regeneration, check for linting errors:

```bash
cd platform/orchestrators/domains/src/{domain}
# Check TypeScript errors
# Fix generator if needed, then regenerate
```

## Troubleshooting

### Orchestrator Not Generated

- Check YAML spec exists: `platform/orchestrators/openapi/src/yaml/{domain}.yaml`
- Verify domain name matches YAML filename
- Check `.servicesgen/config/.orchestrator-domains.yaml` includes the domain

### Import Errors

- Verify `tsconfig.json` has correct path mappings
- Check `baseUrl` points to `platform/` (should be `../../..`)
- Ensure core package is built: `cd packages/core && npm run build`

### Validation Errors

- Check schema naming matches core exports (remove hyphens, lowercase)
- Verify schema exists in core: `packages/core/packages/core/src/{domain}/index.ts`
- Check import statement uses correct domain name

### DAO Repository Errors

- Verify repository is exported from `@quub/adapters`
- Check `deps.ts` includes the repository (auto-discovered from handlers)
- Ensure adapter is built: `cd platform/adapters && npm run build`
