"""
Base generator class - all generators inherit from this

See docs/AI_OPERATION_GUIDE.md for AI operation guidelines.
"""

from abc import ABC, abstractmethod
from pathlib import Path
from typing import Optional

from cuur_codegen.base.context import GenerationContext
from cuur_codegen.base.errors import GenerationError
from cuur_codegen.base.logger import Logger


class GenerateResult:
    """Result of code generation"""

    def __init__(
        self,
        files: list[Path],
        warnings: Optional[list[str]] = None,
        errors: Optional[list[str]] = None,
    ):
        self.files = files
        self.warnings = warnings or []
        self.errors = errors or []

    @property
    def success(self) -> bool:
        """Check if generation was successful"""
        return len(self.errors) == 0


class BaseGenerator(ABC):
    """Base class for all code generators"""

    def __init__(self, logger: Optional[Logger] = None):
        self.logger = logger

    @property
    @abstractmethod
    def name(self) -> str:
        """Generator name"""
        pass

    @property
    @abstractmethod
    def version(self) -> str:
        """Generator version"""
        pass

    @property
    @abstractmethod
    def type(self) -> str:
        """Generator type"""
        pass

    def generate_header(
        self,
        context: GenerationContext,
        description: str,
        generator_name: Optional[str] = None,
        use_auto_generated_format: bool = False,
    ) -> str:
        """Generate file header comment"""
        generator = generator_name or self.name
        version = context.config.version or "1.0.0"

        # Get bundled spec path for source reference
        source_path = ""
        if hasattr(context, 'bundled_path') and context.bundled_path:
            source_path = f"\n * Source: {context.bundled_path}"

        if use_auto_generated_format:
            return f"""/**
 * AUTO-GENERATED CODE — DO NOT EDIT
 *
 * Generator: {generator} v{version}{source_path}
 */

"""
        else:
            return f"""/**
 * {description}
 *
 * Generated by {generator} v{self.version}
 * Generator Version: {version}
 * Domain: {context.domain_name}
 *
 * ⚠️  DO NOT EDIT THIS FILE MANUALLY
 * This file is auto-generated. Any manual changes will be overwritten.
 */

"""

    @abstractmethod
    def generate(self, context: GenerationContext) -> GenerateResult:
        """Generate code - must be implemented by subclasses"""
        pass

    def validate_context(self, context: GenerationContext) -> None:
        """Validate generation context"""
        if not context.spec:
            raise GenerationError("OpenAPI spec not loaded in context", context.domain_name, self.type)

        if not context.domain.enabled:
            raise GenerationError(f"Domain {context.domain_name} is disabled", context.domain_name, self.type)
