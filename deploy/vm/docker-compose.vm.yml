# Docker Compose configuration for VM deployment
# Uses different ports to avoid conflicts with existing apps
# Traefik path-based routing configured

version: "3.8"

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: clinical-decision-engine-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: clinical_decision_engine
    ports:
      - "5433:5432"
    volumes:
      - clinical_decision_engine_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - clinical-decision-engine-network
    restart: unless-stopped

  # Decision Intelligence Service
  decision-intelligence:
    image: clinical-decision-engine-decision-intelligence:latest
    container_name: clinical-decision-engine-decision-intelligence
    pull_policy: never
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/clinical_decision_engine}
      - PORT=3000
      - HOST=0.0.0.0
    ports:
      - "3100:3000"
    labels:
      - traefik.enable=true
      - traefik.http.routers.decision-intelligence.rule=PathPrefix(`/api/decision-intelligence`)
      - traefik.http.routers.decision-intelligence.entrypoints=web
      - traefik.http.services.decision-intelligence.loadbalancer.server.port=3000
      - traefik.http.routers.decision-intelligence.priority=5
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - clinical-decision-engine-network
      - mixpost_default
    restart: unless-stopped

  # Patient Clinical Data Service
  patient-clinical-data:
    image: clinical-decision-engine-patient-clinical-data:latest
    container_name: clinical-decision-engine-patient-clinical-data
    pull_policy: never
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/clinical_decision_engine
      - PORT=3001
      - HOST=0.0.0.0
    ports:
      - "3101:3001"
    labels:
      - traefik.enable=true
      - traefik.http.routers.patient-clinical-data.rule=PathPrefix(`/api/patient-clinical-data`)
      - traefik.http.routers.patient-clinical-data.entrypoints=web
      - traefik.http.services.patient-clinical-data.loadbalancer.server.port=3001
      - traefik.http.routers.patient-clinical-data.priority=5
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - clinical-decision-engine-network
      - mixpost_default
    restart: unless-stopped

  # Knowledge Evidence Service
  knowledge-evidence:
    image: clinical-decision-engine-knowledge-evidence:latest
    container_name: clinical-decision-engine-knowledge-evidence
    pull_policy: never
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/clinical_decision_engine
      - PORT=3002
      - HOST=0.0.0.0
    ports:
      - "3102:3002"
    labels:
      - traefik.enable=true
      - traefik.http.routers.knowledge-evidence.rule=PathPrefix(`/api/knowledge-evidence`)
      - traefik.http.routers.knowledge-evidence.entrypoints=web
      - traefik.http.services.knowledge-evidence.loadbalancer.server.port=3002
      - traefik.http.routers.knowledge-evidence.priority=5
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - clinical-decision-engine-network
      - mixpost_default
    restart: unless-stopped

  # Workflow Care Pathways Service
  workflow-care-pathways:
    image: clinical-decision-engine-workflow-care-pathways:latest
    container_name: clinical-decision-engine-workflow-care-pathways
    pull_policy: never
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/clinical_decision_engine
      - PORT=3003
      - HOST=0.0.0.0
    ports:
      - "3103:3003"
    labels:
      - traefik.enable=true
      - traefik.http.routers.workflow-care-pathways.rule=PathPrefix(`/api/workflow-care-pathways`)
      - traefik.http.routers.workflow-care-pathways.entrypoints=web
      - traefik.http.services.workflow-care-pathways.loadbalancer.server.port=3003
      - traefik.http.routers.workflow-care-pathways.priority=5
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - clinical-decision-engine-network
      - mixpost_default
    restart: unless-stopped

  # Integration Interoperability Service
  integration-interoperability:
    image: clinical-decision-engine-integration-interoperability:latest
    container_name: clinical-decision-engine-integration-interoperability
    pull_policy: never
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/clinical_decision_engine
      - PORT=3004
      - HOST=0.0.0.0
    ports:
      - "3104:3004"
    labels:
      - traefik.enable=true
      - traefik.http.routers.integration-interoperability.rule=PathPrefix(`/api/integration-interoperability`)
      - traefik.http.routers.integration-interoperability.entrypoints=web
      - traefik.http.services.integration-interoperability.loadbalancer.server.port=3004
      - traefik.http.routers.integration-interoperability.priority=5
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - clinical-decision-engine-network
      - mixpost_default
    restart: unless-stopped

  # Dashboard (Frontend)
  dashboard:
    image: clinical-decision-engine-dashboard:latest
    container_name: clinical-decision-engine-dashboard
    pull_policy: never
    environment:
      - NODE_ENV=production
      - VITE_API_BASE_URL=http://34.136.153.216/api/v1
    labels:
      - traefik.enable=true
      - traefik.http.routers.cde.rule=Host(`34.136.153.216`) && PathPrefix(`/cde`)
      - traefik.http.routers.cde.entrypoints=web
      - traefik.http.services.cde.loadbalancer.server.port=8080
      - traefik.http.routers.cde.priority=10
      - traefik.http.middlewares.cde-strip.stripprefix.prefixes=/cde
      - traefik.http.routers.cde.middlewares=cde-strip
    networks:
      - clinical-decision-engine-network
      - mixpost_default
    restart: unless-stopped

volumes:
  clinical_decision_engine_postgres_data:

networks:
  clinical-decision-engine-network:
    driver: bridge
  mixpost_default:
    external: true
